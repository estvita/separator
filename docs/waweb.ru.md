**## Подключение WhatsApp Web к Битрикс24 (серая интеграция)**

Для подключения используется [Evolution API](https://github.com/EvolutionAPI/evolution-api).

Для работы сервиса интеграции требуется Celery.

**### Процесс настройки интеграции**

Для удобства запуска Evolution API вместе с Separator в Docker предусмотрен отдельный файл конфигурации `docker-compose.evolution.yml`.

1.  **Создайте файл конфигурации `.env.evolution`**
    Скопируйте пример конфигурации:
    ```bash
    cp docs/example/env.evolution.example .env.evolution
    ```
    Отредактируйте `.env.evolution`, задав свой `AUTHENTICATION_API_KEY`. Остальные настройки уже оптимизированы для работы внутри Docker-сети Separator.

2.  **Запустите сервисы**
    Используйте следующую команду для запуска Separator вместе с Evolution API:
    ```bash
    docker compose -f docker-compose.yml -f docker-compose.evolution.yml up -d
    ```

**#### Настройки на стороне separator**
separator поддерживает работу с несколькими серверами Evolution API.

+ В админке separator создайте коннектор waweb.
+ Установите [локальное приложение в Битрикс](bitrix.ru.md).
+ В разделе waweb/server/ добавьте сервер Evolution API.
  + **Server URL**: `http://evolution:8080` (внутренний адрес в Docker)
  + **API Key**: Ваш ключ из `AUTHENTICATION_API_KEY` (в файле `.env.evolution`)
  + **max_connections**: количество сессий WhatsApp на один сервер (по умолчанию 100).

> **Примечание:** Благодаря внутренней сети Docker, Separator автоматически доверяет запросам от Evolution API, поэтому в настройках вебхука (`WEBHOOK_GLOBAL_URL`) не требуется указывать API-ключ.

**### Подключение номера WhatsApp к Битрикс24**
Подключение осуществляется из пользовательского интерфейса по адресу /waweb/
+ При нажатии на кнопку "Добавить номер" создается сессия в Evolution API, из которой запрашивается QR-код.
+ Отсканируйте код через приложение WhatsApp на телефоне.
+ После успешного подключения приложения нажмите ссылку "вернуться" под QR-кодом.
+ В таблице со списком подключенных номеров выберите нужный портал Битрикс и подключите существующую линию или создайте новую.

После подключения в Битрикс24 будет создана новая открытая линия с названием, соответствующим номеру подключенного телефона, и [SMS-провайдер](messageservice.md).

SMS-провайдера можно отключить из админки, сняв чекбокс Sms service для нужного номера.