**## Подключение WhatsApp Web к Битрикс24 (серая интеграция)**

Для подключения используется [Evolution API](https://github.com/EvolutionAPI/evolution-api).

Для работы сервиса интеграции требуется Celery.

**### Процесс настройки интеграции**

+ Запустите Evolution API согласно [инструкции](https://doc.evolution-api.com/v2/en/get-started/introduction).
+ В .env установите переменные:
```
WEBHOOK_GLOBAL_ENABLED=true
WEBHOOK_GLOBAL_URL='http://thoth.url/api/waweb/?api-key=XXXX'
AUTHENTICATION_API_KEY=YYY
```

где:
+ thoth.url — адрес установленного портала [thoth](/README_ru.md).
+ XXXX — токен пользователя thoth.
+ YYY — произвольный токен для авторизации в Evolution API.

**#### Настройки на стороне thoth**
thoth поддерживает работу с несколькими серверами Evolution API.
+ В админке thoth создайте коннектор waweb.
+ Установите [локальное приложение в Битрикс](bitrix.ru.md).
+ В разделе waweb/server/ добавьте сервер Evolution API.
+ + Server URL = SERVER_URL (Evolution API)
+ + API Key = AUTHENTICATION_API_KEY (Evolution API)
+ В .env thoth можно использовать переменную WA_SESSIONS_PER_SERVER — количество сессий WhatsApp на один сервер (по умолчанию 100). При достижении этого количества thoth будет искать следующий сервер. Если он не добавлен в админке, при подключении будет выведено сообщение об отсутствии свободных серверов.

**### Подключение номера WhatsApp к Битрикс24**
Подключение осуществляется из пользовательского интерфейса по адресу /waweb/
+ При нажатии на кнопку "Добавить номер" создается сессия в Evolution API, из которой запрашивается QR-код.
+ Отсканируйте код через приложение WhatsApp на телефоне.
+ После успешного подключения приложения нажмите ссылку "вернуться" под QR-кодом.
+ В таблице со списком подключенных номеров выберите нужный портал Битрикс и подключите существующую линию или создайте новую.

После подключения в Битрикс24 будет создана новая открытая линия с названием, соответствующим номеру подключенного телефона, и [SMS-провайдер](messageservice.md).

SMS-провайдера можно отключить из админки, сняв чекбокс Sms service для нужного номера.