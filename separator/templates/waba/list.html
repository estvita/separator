{% extends "base.html" %}
{% load i18n %}
{% block title %}
  {% trans "Your WhatsApp Cloud numbers" %}
{% endblock title %}

{% block content %}
<div class="container">
  <h3>{% trans "Your WhatsApp Cloud numbers" %}</h3>
  {% if phones %}
    <form method="post" class="mb-2">
        {% csrf_token %}
        <div class="d-flex align-items-center">
            <label for="days" class="me-2 mb-0">{% trans "Expires in (days)" %}:</label>
            <input type="number" id="days" name="days" value="{{ days|default:7 }}" min="1" class="form-control me-3" style="width:100px;">
            
            <label for="filter_portal_id" class="me-2 mb-0">{% trans "Portal" %}:</label>
            <select name="filter_portal_id" id="filter_portal_id" class="form-control me-3" style="width:auto;">
                <option value="all" {% if selected_portal_id == "all" %}selected{% endif %}>{% trans "All" %}</option>
                {% for portal in portals %}
                    <option value="{{ portal.id }}" {% if portal.member_id|stringformat:"s" == selected_portal_id|stringformat:"s" %}selected{% endif %}>{{ portal.domain }}</option>
                {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-primary btn-sm me-2" name="action" value="apply">{% trans "Apply" %}</button>
        </div>
    </form>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>{% trans "Number" %}</th>
          <th>{% trans "Type" %}</th>
          <th>{% trans "Expiry Date" %} </th>
          <th>{% trans "Calls" %} </th>
          <th>{% trans "Line ID" %}</th>
          <th>{% trans "Bitrix24 Line" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for phone in phones %}
          <tr {% if phone.expiring_soon %}style="background: #ffdddd;"{% endif %}>
            <td><a href="{% url 'phone-details' phone.id %}">{{ phone.phone }}</a> </td>
            <td>{{ phone.type }}</td>
            <td>
              {% if phone.date_end %}
                {% trans "Messages" %}: {{ phone.date_end }}<br>
              {% endif %}
              {% if phone.sip_extensions %}
                {% trans "Calls" %}: {{ phone.sip_extensions.date_end }}
              {% endif %}
            </td>
            <td>
            <a href="{% url 'phone-details' phone.id %}">
              {% if phone.calling == 'disabled' %}
                {% trans "Disabled" %}
              {% else %}
                {{ phone.call_dest }}
              {% endif %}
            </a>
            </td>
            <td>
              {% if phone.line %}
                <span style="color: green;"> <a href="{% url 'portal_detail' phone.line.portal.id %}">{{ phone.line.portal.domain }}</a> - 
                  <a href="https://{{ phone.line.portal.domain }}/contact_center/connector/?ID={{ phone.line.connector.code }}&LINE={{ phone.line.line_id }}" target="_blank">
                    {{ phone.line.name }} ({{ phone.line.line_id }})</a>
                </span>
              {% else %}
              No line
              {% endif %}
            </td>
            <td>
              <form method="POST" action="{% url 'waba' %}">
                {% csrf_token %}
                <div class="form-group d-flex align-items-center">
                  <select id="line_id" name="line_id" class="form-control mr-2">
                    <option value="" disabled {% if not phone.line %}selected{% endif %}>{% trans "Select a line" %}</option>
                  
                    {% for line in waba_lines %}
                      <option value="{{ line.id }}">{{ line.line_id }} ({{ line.name }}) - {{ line.portal.domain }}</option>
                    {% endfor %}

                    {% for instance in instances %}
                    <option value="create__{{ instance.id }}">âž• {% trans "add line" %} {{ instance.portal.domain }}</option>
                    {% endfor %}
                  </select>
                  <input type="hidden" name="phone_id" value="{{ phone.id }}" />
                  <button type="submit" name="action" value="link" class="btn btn-secondary connect-btn">{% trans "Connect" %}</button>
                </div>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>{% trans "You don't have any connected sessions." %}</p>
  {% endif %}

    <a target="_blank" href="/waba/request?request-id={{ request_id }}" class="btn btn-primary connect-btn">{% trans "Add number" %}</a>

</div>
{% endblock content %}
